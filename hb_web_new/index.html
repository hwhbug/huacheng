<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>社区慧生活</title>
		<script src="js/mui.min.js"></script>
		<link href="css/mui.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<link href="css/iconfont.css" rel="stylesheet" />
		<link href="css/mui.poppicker.css" rel="stylesheet" />
		<link href="css/mui.picker.css" rel="stylesheet" />
		<script type="text/javascript" charset="utf-8">
			mui.init();
		</script>
		<script src="js/mui.picker.js"></script>
		<script src="js/mui.poppicker.js"></script>
		<script src="js/city.data.js"></script>
		<script src="js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/jquery-1.9.1.min.js" type="text/javascript"></script>
		<style>
			.mui-media-body {
				font-size: 12px !important;
			}
			
			.mui-bar .mui-title {
				overflow: inherit;
			}
			
			#showCityPicker3,
			.ui-alert {
				width: 90px !important;
				margin: auto;
			}
			
			header .mui-title {
				margin-left: 30% !important;
			}
			
			.mui-grid-view.mui-grid-9 .mui-table-view-cell {
				padding: 12px 15px !important;
			}
			
			.ban1 {
				width: 40%;
				float: left;
			}
			
			.ban3 {
				width: 100%;
			}
			
			.ban2 {
				width: 60%;
				float: left;
			}
			
			. .footer_banner {
				padding: 1px;
				height: 80%;
			}
			
			.footer_banner img {
				width: 100%;
				display: block;
			}
			
			.shutiao {
				background: #CF2D28;
				margin-left: 10px;
			}
			
			.tubiao {
				padding: 5%;
			}
		</style>
	</head>

	<body>
		<div class="content">

			<!-- 主页面标题 -->

			<header class="mui-bar mui-bar-nav">
				<button id="login" class="login mui-icon icon-myfill">
					<p>登录</p>
				</button>
				<button type="button" style="margin-bottom: 2px; background: #FFFFFF;"><img src="image/index_01.gif"></button>
				<h1 class="mui-title"><button id="showCityPicker3" class="mui-btn mui-btn-block adress" type="button">
					<div id="cityResult3" class="ui-alert">  </div>
				</button>
				</h1>
			</header>
			<!--主界面区域-->
			<div class="mui-content mui-scroll-wrapper index_content">
				<div class="mui-scroll">

					<!-- 主界面具体展示内容 -->
					<!--banner-->
					<div class="mui-slider">
						<div class="mui-slider-group">
							<div class="mui-slider-item">
								<!--<img src="http://101.201.196.202:82/Images/NewsImg/20160416191443_3132.jpg">-->
							</div>
						</div>
					</div>
					<!--banner区域结束-->
					<!--按钮区域-->

					<div id="container">
						<ul class="mui-table-view mui-grid-view mui-grid-9 btn_nav">

							<li class="tubiao" id="wuye">
								<a href="#">
									<span class="mui-icon icon-sponsorfill"></span>
									<div class="mui-media-body">物业缴费</div>
								</a>
							</li>
							<li class="tubiao">
								<a id="repair" href="#">
									<span class="mui-icon icon-wrench"></span>
									<div class="mui-media-body">保洁修理</div>
								</a>
							</li>
							<li class="tubiao">
								<a id="jiazheng" href="#">
									<span class="mui-icon icon-xinshenger"></span>
									<div class="mui-media-body">保姆在线</div>
								</a>
							</li>
							<li id="shop" class="tubiao">
								<a href="#">
									<span class="mui-icon icon-shop"></span>
									<div class="mui-media-body">周边购物</div>
								</a>
							</li>
							<li id="falv" class="tubiao">
								<a href="#">
									<span class="mui-icon icon-falv"></span>
									<div class="mui-media-body">法律援助</div>
								</a>
							</li>
							<li id="yanglao" class="tubiao">
								<a href="#">
									<span class="mui-icon icon-usersecret"></span>
									<div class="mui-media-body">居家养老</div>
								</a>
							</li>
							<li id="tousu" class="tubiao">
								<a href="#">
									<span class="mui-icon icon-woyaotousu"></span>
									<div class="mui-media-body">投诉专区</div>
								</a>
							</li>
							<li id="communityBulletin" class="tubiao" id="gonggao">
								<a href="#">
									<span class="mui-icon icon-gonggao"></span>
									<div class="mui-media-body">小区公告</div>
								</a>
							</li>
						</ul>

						<div class="footer_banner ">
							<p>
								<div class="shutiao"></div>特惠组合</p>
							<div id="list_Advert">
								<!--<div class="ban1"><img src="image/zz1.jpg" /></div>
								<div class="ban2"><img src="image/zz2.jpg" /></div>
								<div class="ban3"><img src="image/zz3.jpg" /></div>
								<div class="ban2"><img src="image/zz2.jpg" /></div>
								<div class="ban1"><img src="image/zz1.jpg" /></div>-->
							</div>
						</div>

						<div class="mui-off-canvas-backdrop"></div>
						<div id="map" style="height: 500px;"></div>
					</div>

				</div>

				<script src="js/geturl.js"></script>
				<script src="js/pages/index/index.js"></script>
				<script>
					mui(".mui-scroll-wrapper").scroll();
					var url = "";
					mui.plusReady(function() {
						plus.storage.setItem("url", "101.201.196.202:82");
						mui.ajax("http://" + plus.storage.getItem("url") + "/home/login_cache", {
								data: {},
								dataType: "json", //服务器返回json格式数据
								async: true,
								type: "GET", //HTTP请求类型,
								timeout: 10000, //超时时间设置为10秒；
								success: function(data) {
									if (data.name != null && data.name != "") {
										console.log(data.name)
										$(".login").html("<p>" + data.name + "</p>");
									} else {
										console.log(data.name)
										if (data.uname != "" && data.uname != null) {
											console.log(data.name)
											$(".login").html("<p></p>");
										}
									}
								}
							})
							//头部广告位
						mui.ajax("http://" + plus.storage.getItem("url") + "/home/Advert_index", {
							data: {},
							dataType: "json", //服务器返回json格式数据
							async: true,
							type: "GET", //HTTP请求类型,
							timeout: 10000, //超时时间设置为10秒；
							success: function(data) {
								//									alert(data.length)
								var str = "";
								for (var i = 0; i < data.length; i++) {
									str += "<div class=\"mui-slider-item\"><img src=\"http://" + plus.storage.getItem("url") + "/Images/NewsImg/" + data[i].Image1 + "\"></div>"
								}
								$(".mui-slider-group").html(str);
							}
						})
						//底部广告位
						mui.ajax("http://" + plus.storage.getItem("url") + "/home/Advert_indexlist", {
							data: {},
							dataType: "json", //服务器返回json格式数据
							async: true,
							type: "GET", //HTTP请求类型,
							timeout: 10000, //超时时间设置为10秒；
							success: function(data) {
								console.log(data.length)
								var str = "";
								for (var i = 0; i < data.length; i++) {
									if (data[i].Type=="2") {
										str+="<div id=\""+data[i].Products_ID +"\" class=\"ban1\"><img src=\"http://" + plus.storage.getItem("url") + "/Images/NewsImg/" + data[i].Image1 + "\"/></div>";
									}else if(data[i].Type=="3"){
										str+="<div id=\""+data[i].Products_ID +"\" class=\"ban2\"><img src=\"http://" + plus.storage.getItem("url") + "/Images/NewsImg/" + data[i].Image1 + "\"/></div>";
									}else if(data[i].Type=="4"){
										str+="<div id=\""+data[i].Products_ID +"\" class=\"ban3\"><img src=\"http://" + plus.storage.getItem("url") + "/Images/NewsImg/" + data[i].Image1 + "\"/></div>";
									}else if(data[i].Type=="5"){
										str+="<div id=\""+data[i].Products_ID +"\" class=\"ban2\"><img src=\"http://" + plus.storage.getItem("url") + "/Images/NewsImg/" + data[i].Image1 + "\"/></div>";
									}else if(data[i].Type=="6"){
										str+="<div id=\""+data[i].Products_ID +"\" class=\"ban1\"><img src=\"http://" + plus.storage.getItem("url") + "/Images/NewsImg/" + data[i].Image1 + "\"/></div>";
									}
								}
								$("#list_Advert").html(str);
							}
						})
						mui("#list_Advert").on("tap", "div", function(e) {
							var cuxiao_id = this.getAttribute("id");
							//获得详情页面
							if (!cuxiao_detailPage) {
								cuxiao_detailPage = plus.webview.getWebviewById("shopping/shop_cuxiao_acter.html");
							}
							//触发详情页面的newsId事件
							mui.fire(cuxiao_detailPage, "productsId", {
								cuxiao_id: cuxiao_id
							});
							//打开详情页面          
							mui.openWindow({
								url: "shopping/shop_cuxiao_acter.html",
								id: "shopping/shop_cuxiao_acter.html"
							});
						});
						mui.init({
							preloadPages: [{
								id: "shopping/shop_cuxiao_acter.html",
								url: "shopping/shop_cuxiao_acter.html"
							}]
						});
						var cuxiao_detailPage = null;
						//添加列表项的点击事件
						mui("#index-product").on("tap", "li", function(e) {
							var cuxiao_id = this.getAttribute("id");
							//获得详情页面
							if (!cuxiao_detailPage) {
								cuxiao_detailPage = plus.webview.getWebviewById("shopping/shop_cuxiao_acter.html");
							}
							//触发详情页面的newsId事件
							mui.fire(cuxiao_detailPage, "productsId", {
								cuxiao_id: cuxiao_id
							});
							//打开详情页面          
							mui.openWindow({
								url: "shopping/shop_cuxiao_acter.html",
								id: "shopping/shop_cuxiao_acter.html"
							});
						});
					});
					//*********************退出应用*****************************
					var first = null;
					mui.back = function() {
							if (!first) {
								first = new Date().getTime();
								plus.nativeUI.toast("再按一次退出应用");
								setTimeout(function() {
									first = null;
								}, 1000);
							} else {
								if (new Date().getTime() - first < 1000) {
									plus.runtime.quit();
								}
							}
						}
						//					window.addEventListener("newsId", function(event) {
						//							//获得事件参数
						//							mui.ajax("http://" + plus.storage.getItem("url") + "/home/login_cache", {
						//								data: {},
						//								dataType: "json", //服务器返回json格式数据
						//								async: true,
						//								type: "GET", //HTTP请求类型,
						//								timeout: 10000, //超时时间设置为10秒；
						//								success: function(data) {
						//									//									if (data.name != null && data.name != "") {
						//									//										$(".login").html("<p>" + data.name + "</p>")
						//									//									}
						//									console.log(data.name)
						//									alert()
						//									if (data.name != null && data.name != "") {
						//										$(".login").html("<p>" + data.name + "</p>");
						//									} else {
						//										if (data.uname != "" && data.uname != null) {
						//											$(".login").html("<p></p>");
						//										}
						//									}
						//								}
						//							})
						//						})
						// 扩展API加载完毕后调用onPlusReady回调函数 
					document.addEventListener("plusready", onPlusReady, false);
					// 扩展API加载完毕，现在可以正常调用扩展API
					function onPlusReady() {
						// 使用百度地图地位模块获取位置信息
						var weidu = null;
						var jingdu = null;
						var map = new plus.maps.Map("map");
						map.hide();
						// 将检索到结果作为标点添加到地图中
						var searchObj = new plus.maps.Search(map);
						console.log(plus.storage.getItem("Communitycoord"));
						//地图获取当前位置
						map.getUserLocation(function(state, point) {
							if (0 == state) {
								plus.storage.setItem("Locate", JSON.stringify(point));
								//根据坐标获取地理位置信息
								plus.maps.Map.reverseGeocode(point, {}, function(event) {
									var address = event.address; // 转换后的地理位置
									mui.ajax("http://" + plus.storage.getItem("url") + "/info/getdis_id", {
										data: {
											dis_name: address.substring(address.indexOf("区") - 2, address.indexOf("区"))
										},
										async: true,
										dataType: "json", //服务器返回json格式数据
										type: "Post", //HTTP请求类型,
										timeout: 10000, //超时时间设置为10秒；
										success: function(Communitydata) {
											if (Communitydata != "" && Communitydata != null) {
												mui.ajax("http://" + plus.storage.getItem("url") + "/info/Community_Load", {
													data: {},
													async: false,
													dataType: "json", //服务器返回json格式数据
													type: "Post", //HTTP请求类型,
													timeout: 10000, //超时时间设置为10秒；
													success: function(Community_data) {
														(function($, doc) {
															$.init();
															$.ready(function() {
																var cityPicker3 = new $.PopPicker();
																cityPicker3.setData(eval(Community_data));
																var showCityPickerButton = doc.getElementById("showCityPicker3");
																var cityResult3 = doc.getElementById("cityResult3");
																if (Communitydata == null) {
																	cityResult3.innerText = "暂未覆盖该区域"
																} else {
																	if (plus.storage.getItem("Community") != null) {
																		cityResult3.innerText = plus.storage.getItem("Community");
																	} else {
																		cityResult3.innerText = "选择小区"
																	}
																	//*************************************小区选择点击事件*************************************
																	showCityPickerButton.addEventListener("tap", function(event) {
																		cityPicker3.show(function(items) {
																			cityResult3.innerText = (items[0] || {}).text;
																			plus.storage.setItem("Community", (items[0] || {}).text);
																			///**********************************获取用户选择小区的坐标*********************************
																			searchObj.onPoiSearchComplete = function(state, result) {
																				if (state == 0) {
																					if (result.currentNumber <= 0) {
																						alert("没有检索到结果");
																					}
																					for (var i = 0; i < 1; i++) {
																						var pos = result.getPosition(i);
																						console.log(JSON.stringify(pos.point))
																						plus.storage.setItem("Communitycoord", JSON.stringify(pos.point));
																					}
																				} else {
																					alert("检索失败");
																				}
																			}
																			searchObj.poiSearchNearBy((items[0] || {}).text, point, 10000); //周边检索
																		});
																	}, false);
																}
															});
														})(mui, document);
													}
												})
											} else {
												(function($, doc) {
													$.init();
													$.ready(function() {
														//-----------------------------------------
														//					//级联示例
														var cityResult3 = doc.getElementById("cityResult3");
														cityResult3.innerText = "暂未覆盖该区域……";
													});
												})(mui, document);
											}
										}
									})
								}, function(e) {
									alert("Failed:" + JSON.stringify(e));
								});
							} else {
								alert("获取当前位置失败，请检查网络");
							}
						});
					}
					//						//********************************头部小区选择**************************************
					//						mui.ajax("http://" + plus.storage.getItem("url") + "/info/Community_Load1", {
					//							data: {
					//								//								id: Communitydata.ID
					//							},
					//							async: true,
					//							dataType: "json", //服务器返回json格式数据
					//							type: "Post", //HTTP请求类型,
					//							timeout: 10000, //超时时间设置为10秒；
					//							success: function(Communitydatanew) {
					//								(function($, doc) {
					//									$.init();
					//									$.ready(function() {
					//										//-----------------------------------------
					//										//					//级联示例
					//										var cityPicker3 = new $.PopPicker();
					//										//																console.log(eval(Communitydatanew))
					//										cityPicker3.setData(eval(Communitydatanew));
					//										var showCityPickerButton = doc.getElementById("showCityPicker3");
					//										var cityResult3 = doc.getElementById("cityResult3");
					////										if (Communitydata == null) {
					////											cityResult3.innerText = "暂未覆盖该区域"
					////										} else {
					//											if (plus.storage.getItem("Community") != null) {
					//												cityResult3.innerText = plus.storage.getItem("Community");
					//											} else {
					//												cityResult3.innerText = "选择小区"
					//											}
					//											//*************************************小区选择点击事件*************************************
					//											showCityPickerButton.addEventListener("tap", function(event) {
					//												cityPicker3.show(function(items) {
					//													cityResult3.innerText = (items[0] || {}).text;
					//													plus.storage.setItem("Community", (items[0] || {}).text);
					//													///**********************************获取用户选择小区的坐标*********************************
					//													searchObj.onPoiSearchComplete = function(state, result) {
					//														if (state == 0) {
					//															if (result.currentNumber <= 0) {
					//																alert("没有检索到结果");
					//															}
					//															for (var i = 0; i < 1; i++) {
					//																var pos = result.getPosition(i);
					//																console.log(JSON.stringify(pos.point))
					//																plus.storage.setItem("Communitycoord", JSON.stringify(pos.point));
					//															}
					//														} else {
					//															alert("检索失败");
					//														}
					//													}
					//													searchObj.poiSearchNearBy((items[0] || {}).text, point, 10000); //周边检索
					//												});
					//											}, false);
					////										}
					//									});
					//								})(mui, document);
					//								//}
					//							}
					//						})
				</script>
	</body>

</html>