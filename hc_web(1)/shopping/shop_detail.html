<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/style.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/cross-down.css" rel="stylesheet" />
		<script src="../js/jquery-1.9.1.min.js" type="text/javascript"></script>
		<style>
			html,
			body {
				background-color: #F7F7F7;
			}
			
			.mui-views,
			.mui-view,
			.mui-pages,
			.mui-page,
			.mui-page-content {
				position: absolute;
				left: 0;
				right: 0;
				top: 0;
				bottom: 0;
				width: 100%;
				height: 100%;
				background-color: #F7F7F7;
			}
			
			.mui-pages {
				top: 46px;
				height: auto;
			}
			
			.mui-scroll-wrapper,
			.mui-scroll {
				background-color: #F7F7F7;
			}
			
			.mui-page.mui-transitioning {
				-webkit-transition: -webkit-transform 300ms ease;
				transition: transform 300ms ease;
			}
			
			.mui-page-left {
				-webkit-transform: translate3d(0, 0, 0);
				transform: translate3d(0, 0, 0);
			}
			
			.mui-ios .mui-page-left {
				-webkit-transform: translate3d(-20%, 0, 0);
				transform: translate3d(-20%, 0, 0);
			}
			
			.mui-navbar {
				position: fixed;
				right: 0;
				left: 0;
				z-index: 10;
				height: 44px;
				background-color: #f7f7f8;
			}
			
			.mui-navbar .mui-bar {
				position: absolute;
				background: transparent;
				text-align: center;
			}
			
			.mui-android .mui-navbar-inner.mui-navbar-left {
				opacity: 0;
			}
			
			.mui-ios .mui-navbar-left .mui-left,
			.mui-ios .mui-navbar-left .mui-center,
			.mui-ios .mui-navbar-left .mui-right {
				opacity: 0;
			}
			
			.mui-navbar .mui-btn-nav {
				-webkit-transition: none;
				transition: none;
				-webkit-transition-duration: .0s;
				transition-duration: .0s;
			}
			
			.mui-navbar .mui-bar .mui-title {
				display: inline-block;
				width: auto;
			}
			
			.mui-page-shadow {
				position: absolute;
				right: 100%;
				top: 0;
				width: 16px;
				height: 100%;
				z-index: -1;
				content: "";
			}
			
			.mui-page-shadow {
				background: -webkit-linear-gradient(left, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
				background: linear-gradient(to right, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
			}
			
			.mui-navbar-inner.mui-transitioning,
			.mui-navbar-inner .mui-transitioning {
				-webkit-transition: opacity 300ms ease, -webkit-transform 300ms ease;
				transition: opacity 300ms ease, transform 300ms ease;
			}
			
			.mui-page {
				display: none;
			}
			
			.mui-pages .mui-page {
				display: block;
			}
			
			.mui-page .mui-table-view:first-child {
				margin-top: 15px;
			}
			
			.mui-page .mui-table-view:last-child {
				margin-bottom: 30px;
			}
			
			.mui-table-view {
				margin-top: 20px;
			}
			
			.mui-table-view span.mui-pull-right {
				color: #999;
			}
			
			.mui-table-view-divider {
				background-color: #FFFFFF;
				font-size: 14px;
			}
			
			.mui-table-view-divider:before,
			.mui-table-view-divider:after {
				height: 0;
			}
			
			.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			
			.mui-ios .mui-navbar .mui-bar .mui-title {
				position: static;
			}
		</style>
		<style>
			.mui-backdrop {
				position: absolute !important;
				z-index: 100 !important;
				height: 40%;
				top: 0;
			}
			
			.active {
				border: 1px solid #CF2D28;
				color: #CF2D28;
			}
			
			a {
				color: #333333;
			}
		</style>
	</head>

	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar"> </div>
				<div class="mui-pages"> </div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<!-- 侧滑导航根容器 -->
		<div id="setting" class="mui-page">
			<!--页面标题栏开始-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav"> <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left"> <span class="mui-icon mui-icon-left-nav"></span> </button>
				<h1 class="mui-center mui-title"></h1> </div>
			<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable">
				<!-- 主页面容器 -->
				<div class="mui-inner-wrap">
					<div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper shop">
						<div class="mui-scroll">
							<!--banner-->
							<div class="mui-slider">
								<div class="mui-slider-group" id="Gallery">
									<div class="mui-slider-item">
										<!--<img src="../image/cp1.jpg" />-->
									</div>
								</div>
							</div>
							<!--banner区域结束-->
							<!--按钮区域-->
							<div class="shop_acter_text">
								<div class="left">
									<h2 class="pro_name"></h2>
									<h2 class="font-red mx_jiage">￥</h2>
									<p class="black price" style="display: none;">原价：<span class="zhonghuaxian">￥</span> | 销量：<span class="Quantity"></span>件</p>
								</div>
								<div class="right"> <button id="add_shop_car" type="button" class="mui-btn mui-btn-danger red jiesuan_btn"> 加入购物车 <!--<span class="mui-badge mui-badge-danger">1</span>--> </button> <button id="shop_car" type="button" class="mui-btn mui-badge-danger yellow jiesuan_btn"> 去结算 </button>									</div>
							</div>
							<div id="endtime" class="repair3_table" style="line-height: 30px; color:#666666;display: none;">
								据结束：<span class="settime red font-bai mx_jiage" style=" font-family:arial; padding: 0 10px;" endtime=""></span>
							</div>
							<div class="repair3_table" style="line-height: 30px; color:#666666;"> <a href="#bottomPopover" class="xuanze">商品属性： <span id="choise" class="choise"></span> <span id="productattr" style="display: none;"/></span> <span id="choise_productattrname" style="display: none;"/></span> <span class="mui-icon mui-icon-arrowright mui-pull-right" style="line-height: 30px;"></span> </a>								</div>
							<div id="shop_list" class="repair3_table" style="line-height: 30px; color:#666666; display: none;"> <a class="xuanze" href="#shangjia_choice">选择商家 : <span id="shanghu" ></span> <input id="shangjia_name" hidden="hidden"/> <span class="mui-icon mui-icon-arrowright mui-pull-right" style="line-height: 30px;"></span> </a> </div>
							<div class="repair3_table" style="line-height: 30px; color:#666666;"> <a>数量 :</a>
								<div class="mui-numbox mui-pull-right" data-numbox-min="1" data-numbox-max="20"> <button class="mui-btn mui-numbox-btn-minus" type="button">-</button> <input id="buynumber" style="margin-top:0 !important;" class="mui-numbox-input" type="number" value="1" /> <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>									</div>
							</div>
							<div class="red font-bai" style="padding: 5px; margin-top: 5px;">商品详情</div>
							<div class="shop_main">
								<!--<img src="../image/sd7.png" />--></div>
							<div class="mui-off-canvas-backdrop"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="shangjia_choice" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav"> <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left"> <span class="mui-icon mui-icon-left-nav"></span> </button>
				<h1 class="mui-center mui-title">选择商家</h1> </div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div id="container">
						<!--按钮区域结束-->
						<!--商家列表-->
						<div id="slider" class="mui-slider" style="height:100%;">
							<div id="slider2SegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted"> 
								<a class="mui-control-item" href="#item1mobile">  所有</a> 
								<!--<a class="mui-control-item" href="#item2mobile"> 5公里内 </a> 1公里内
								<a class="mui-control-item" href="#item3mobile"> 所有 </a>--> </div>
							<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-4"></div>
							<div class="mui-slider-group">
								<!--1公里内-->
								<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
									<div id="scroll1" class="mui-scroll-wrapper">
										<div class="mui-scroll">
											<!--商家列表分类-->
											<ul class="mui-table-view mui-grid-view mui-grid-9 list_shop mui-table-view-radio">
												
											</ul>
										</div>
									</div>
								</div>
								<!--5公里内-->
								<!--<div id="item2mobile" class="mui-slider-item mui-control-content">
									<div id="scroll2" class="mui-scroll-wrapper">
										<div class="mui-scroll">
											<div class="mui-loading">
												<ul class="mui-table-view mui-grid-view mui-grid-9 list_shop mui-table-view-radio"> </ul>
											</div>
										</div>
									</div>
								</div>
								<div id="item3mobile" class="mui-slider-item mui-control-content">
									<div id="scroll3" class="mui-scroll-wrapper">
										<div class="mui-scroll">
											<div class="mui-loading">
												<ul class="mui-table-view mui-grid-view mui-grid-9 list_shop mui-table-view-radio"> </ul>
											</div>
										</div>
									</div>
								</div>-->
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!--弹出属性菜单-->
		<div id="bottomPopover" class="mui-popover mui-popover-bottom">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div class="repair3_table" style="border-bottom: 1px solid  #EEEEEE;">
						<div class="sm_shop_img"></div>
						<div class="right">
							<h2 class="pro_name"></h2>
							<h2 class="font-red mx_jiage">￥</h2>
							<p class="black price" style="display: none;">原价：<span class="zhonghuaxian">￥</span>" | 销量：<span class="Quantity"></span>件</p>
						</div>
						<div style="clear: both;"></div>
					</div>
					<div class="tanchu_shuxing"> </div>
				</div>
			</div>
		</div>
		<!--弹出属性菜单-->
		<script src="../js/mui.min.js"></script>
		<script src="../js/myapp.js"></script>
		<script src="../js/app.js"></script>
		<script src="../js/mui.view.js "></script>
		<script>
			mui(".mui-scroll-wrapper").scroll();
			var viewApi = mui("#app").view({
				defaultPage: "#setting"
			});
			mui.init();
			//*************************************结算************************************
			document.getElementById("shop_car").addEventListener("tap", function() {
				//打开关于页面
				mui.ajax("http://" + plus.storage.getItem("url") + "/product/whetherlogin", {
					data: {},
					dataType: "json", //服务器返回json格式数据
					async: true,
					type: "Post", //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						if (data.statusCode == 200) {
							mui.openWindow({
								url: "shop_car.html",
								id: "shop_car"
							});
						} else {
							plus.ui.toast(data.message);
						}
					}
				})
			});
			//**********************************以下为获取数据**********************************************
			var id = "";
			var type = "";
			window.addEventListener("productsId", function(event) {
				//获得事件参数
				id = event.detail.id;
				alert(id);
				console.log(id);
				//				页面加载时，清空数据层的缓存数据
				$(".mui-title").empty();
				$(".left .pro_name").empty();
				$(".left .font-red.mx_jiage").empty();
				$(".left .zhonghuaxian").empty();
				$(".shop_main").empty();
				$(".right .pro_name").empty();
				$(".right .font-red.mx_jiage").empty();
				$(".right .zhonghuaxian").empty();
				$(".sm_shop_img").empty();
				$(".tanchu_shuxing").empty();
				$(".choise").empty();
				$(".Quantity").empty();
				$("#choise_productattrname").empty();
				//根据id向服务器请求新闻详情
				//判断是否是商户的产品，activity为1时，商品是可供商户选择的产品
				mui.ajax("http://" + plus.storage.getItem("url") + "/product/Panicbuy_Detail", {
					data: {
						id: id,
					},
					dataType: "json", //服务器返回json格式数据
					async: true,
					type: "GET", //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						alert(data)
						meiyoushanghu(id);
						type = data.activity;
						if (data.activity != "1") {
							//************************************通过商品id获取商户提交的产品价格******************************************
							$(".price").show();
							$("#shop_list").hide();
							if (data.activity == "4") {
								$("#endtime").show();
								$(".settime").attr("endtime", data.EndTime);
							} else {
								$("#endtime").hide();
							}
						} else {
							$(".price").hide();
							$("#shop_list").show();
							mui.ajax("http://" + plus.storage.getItem("url") + "/Business/price_byproductid", {
									data: {
										product_id: id,
									},
									dataType: "json", //服务器返回json格式数据
									async: true,
									type: "GET", //HTTP请求类型,
									timeout: 10000, //超时时间设置为10秒；
									success: function(data) {
										$(".left .font-red.mx_jiage").html("￥" + data);
									}
								}) //*************************************************根据商品id获取商户列表结束**********************************
								//*************************************************根据商品id获取商户列表**********************************
							mui.ajax("http://" + plus.storage.getItem("url") + "/Business/busslist_byproductid", {
									data: {
										product_id: id,
									},
									dataType: "json", //服务器返回json格式数据
									async: true,
									type: "GET", //HTTP请求类型,
									timeout: 10000, //超时时间设置为10秒；
									success: function(data) {
//										alert(data.length)
										var bustr = "";
										for (var bu = 0; bu < data.length; bu++) {
											alert(data[bu].Admin_User.name)
											bustr += "<li id=\"" + data[bu].ID + "\" value=\"" + data[bu].Admin_User.name + "\" class=\"mui-table-view-cell mui-media mui-col-xs-6 mui-col-sm-6 mui-selected shanghu_list\"><h2>" + data[bu].Admin_User.name + "</h2><p class=\"black\">地址：" + data[bu].Admin_User.Address + "</p>" + "<button id=\"shop_user\" class=\"kankan\"><span class=\"mui-icon mui-icon-redo\"></span>进店看看</button><p class=\"black fuwu\">更多服务：</p>" + data[bu].Description + "<p>销量：120笔</p></li>"
										}
										$("#item1mobile").html(bustr);
									}
								}) //*************************************************根据商品id获取商户列表结束**********************************
						}
					}
				})
			});
			//*************************************加入购物车*****************************
			var settings = app.getSettings();
			var add_shop_car = document.getElementById("add_shop_car");
			var choise_productattrname = document.getElementById("choise_productattrname");
			var buynumber = document.getElementById("buynumber");
			var productattr = document.getElementById("productattr");
			var business_id = document.getElementById("shangjia_name") //正则表达式判断空格出现的次数
			var re = new RegExp("&nbsp;", "g");
			var reattr = new RegExp(",", "g");
			add_shop_car.addEventListener("tap", function(event) {
				if (choise_productattrname.innerHTML.replace(/\&nbsp;/g, ",") == "") {
					plus.ui.toast("请完善信息");
					return;
				} else {
					if (choise_productattrname.innerHTML.match(re).length != productattr.innerHTML.match(reattr).length) {
						plus.ui.toast("属性选择不完善");
						return;
					}
				}
				if (business_id.value == "") {
					plus.ui.toast("请选择商户");
					return;
				} 
				console.log(productattr.innerHTML + buynumber.value + choise_productattrname.innerHTML.replace(/\&nbsp;/g, ",") + id + business_id.value)
				console.log(business_id.value)
					//****************************用户提交成功返回*********************************
				mui.ajax("http://" + plus.storage.getItem("url") + "/product/AddCart", {
					data: {
						"ProAttrType": productattr.innerHTML,
						"Quantity": buynumber.value,
						"ProAttrName": choise_productattrname.innerHTML.replace(/\&nbsp;/g, ","), //正则表达式替换所有字符
						"Products_ID": id,
						"ShoppingCartType": type,
						"Business_ID": business_id.value
					},
					dataType: "json", //服务器返回json格式数据
					async: true,
					type: "Post", //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						if (data.statusCode == 200) {
							plus.ui.toast(data.message);
						} else {
							plus.ui.toast(data.message);
						}
					}
				})
			});
			//***************************************根据id获取产品详情**********************************写成了函数
			function meiyoushanghu(product_id) {
				mui.ajax("http://" + plus.storage.getItem("url") + "/product/Panicbuy_Detail", {
					data: {
						id: product_id,
					},
					dataType: "json", //服务器返回json格式数据
					async: true,
					type: "GET", //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						var str = "";
						//alert(cuxiao_id)
						$(".mui-title").html(data.Names);
						$(".left .pro_name").html(data.Names);
						$(".left .font-red.mx_jiage").html("￥" + data.Price2);
						$(".left .zhonghuaxian").html("￥" + data.Price1);
						$(".shop_main").html(data.Description.replace(/\/Images/g, "http://" + plus.storage.getItem("url") + "/Images"));
						$(".right .pro_name").html(data.Names);
						$(".right .font-red.mx_jiage").html("￥" + data.Price1);
						$(".right .zhonghuaxian").html("￥" + data.Price2);
						$(".Quantity").html(data.Quantity);
						$(".sm_shop_img").html("<img src=\"http://" + plus.storage.getItem("url") + "/Images/ProductImg/" + data.Brand.brand_logo + " \"/>");
						//获取产品的相册列表
						mui.ajax("http://" + plus.storage.getItem("url") + "/product/Panicbuy", {
							data: {
								productid: data.ID
							},
							dataType: "json", //服务器返回json格式数据
							async: true,
							type: "GET", //HTTP请求类型,
							timeout: 10000, //超时时间设置为10秒；
							success: function(data1) {
								var gallery = "";
								//服务器返回响应，根据响应结果，分析是否登录成功；
								for (var j = 0; j < data1.length; j++) {
									gallery += "<div class=\"mui-slider-item\"><img src=\"http://" + plus.storage.getItem("url") + "/Images/ProductImg/" + data1[j].Names + "\" /></div>";
								}
								$("#Gallery").html(gallery);
							}
						});
						//获取属性列表
						mui.ajax("http://" + plus.storage.getItem("url") + "/product/Panicbuy_Purchase", {
							data: {
								producttypeid: data.ProductsType_ID,
							},
							dataType: "json", //服务器返回json格式数据
							async: true,
							type: "GET", //HTTP请求类型,
							timeout: 10000, //超时时间设置为10秒；
							success: function(data2) {
								//服务器返回响应，根据响应结果，分析是否登录成功；
								//获取所属产品的属性列表
								var ProductAttribute = "";
								var post_attr = "";
								mui.getJSON("http://" + plus.storage.getItem("url") + "/product/Customers_Detail", {
									productid: data.ID,
								}, function(data3) {
									for (var i = 0; i < data2.length; i++) {
										ProductAttribute += "<p class =\"black\">" + data2[i].Names + "</p><div>";
										for (var p = 0; p < data3.length; p++) {
											if (data3[p].ProductAttributeType_ID == data2[i].ID) {
												ProductAttribute += "<div class=\"mui-btn\">" + data3[p].Names + "<span class=\"shuxing_block\">&nbsp;</span></div>"
											}
										}
										ProductAttribute = ProductAttribute + "</div>";
										post_attr += data2[i].Names + ",";
									}
									$(".tanchu_shuxing").html(ProductAttribute);
									$("#productattr").html(post_attr);
									//*****************************此为选中提交js************************
									$(".tanchu_shuxing .mui-btn").click(function() {
										if ($(this).hasClass("active")) {
											$(this).removeClass("active")
										} else {
											$(this).siblings(".mui-btn").removeClass("active");
											$(this).addClass("active");
										}
										$(".choise").html($(".tanchu_shuxing .active").text());
										$("#choise_productattrname").html($(".tanchu_shuxing .active").text());
									});
									//*****************************此为选中提交js************************
								});
							}
						});
					}
				})
			}
			//************************************************函数结束********************************************
			////********************************************************选择商家的数据代码开始*****************************************
			//**********************************以下为页面切换代码******************************
			var view = viewApi.view;
			(function($, doc) {
				//处理view的后退与webview后退
				var oldBack = $.back;
				$.back = function() {
					if (viewApi.canBack()) {
						//如果view可以后退，则执行view的后退
						viewApi.back();
					} else {
						//执行webview后退
						oldBack();
					}
				};
				//监听页面切换事件方案1,通过view元素监听所有页面切换事件，目前提供pageBeforeShow|pageShow|pageBeforeBack|pageBack四种事件(before事件为动画开始前触发)
				//第一个参数为事件名称，第二个参数为事件回调，其中e.detail.page为当前页面的html对象
				view.addEventListener("pageBeforeShow", function(e) {});
				view.addEventListener("pageShow", function(e) {});
				view.addEventListener("pageBeforeBack", function(e) {});
				view.addEventListener("pageBack", function(e) {});
				//*************************************地址点击带回********************************
				mui("#slider").on("tap", "li", function(e) {
					var Business_id = this.getAttribute("id");
					var Business_name = this.getAttribute("value");
					doc.getElementById("shanghu").innerHTML = Business_name;
					doc.getElementById("shangjia_name").value = Business_id;
					viewApi.back();
				});
				//*************************************地址点击带回结束********************************
			})(mui, document);
			//**********************************页面切换代码结束******************************
		</script>
		<script>
			$(function() {
				updateEndTime();
			});
			//*******************************倒计时函数******************************
			function updateEndTime() {
				var date = new Date();
				var time = date.getTime(); //当前时间距1970年1月1日之间的毫秒数
				$(".settime").each(function(i) {
					var endDate = this.getAttribute("endTime"); //结束时间字符串
					//转换为时间日期类型
					var endDate1 = eval("new Date(" + endDate.replace(/\d+(?=-[^-]+$)/,
						function(a) {
							return parseInt(a, 10) - 1;
						}).match(/\d+/g) + ")");
					var endTime = endDate1.getTime(); //结束时间毫秒数
					var lag = (endTime - time) / 1000; //当前时间和结束时间之间的秒数
					if (lag > 0) {
						var second = Math.floor(lag % 60);
						var minite = Math.floor((lag / 60) % 60);
						var hour = Math.floor((lag / 3600) % 24);
						var day = Math.floor((lag / 3600) / 24);
						$(this).html(day + "天" + hour + "小时" + minite + "分" + second + "秒");
					} else
						$(this).html("活动结束啦！");
				});
				setTimeout("updateEndTime()", 1000);
			}
		</script>
	</body>

</html>