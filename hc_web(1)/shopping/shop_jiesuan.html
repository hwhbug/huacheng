<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/style.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/cross-down.css" rel="stylesheet" />
		<script src="../js/mui.min.js"></script>
		<script src="../js/jquery-1.9.1.min.js" type="text/javascript"></script>
		<style>
			html,
			body {
				background-color: #FFFFFF;
			}
			
			.mui-views,
			.mui-view,
			.mui-pages,
			.mui-page,
			.mui-page-content {
				position: absolute;
				left: 0;
				right: 0;
				top: 0;
				bottom: 0;
				width: 100%;
				height: 100%;
				background-color: #FFFFFF;
			}
			
			.mui-pages {
				top: 46px;
				height: auto;
			}
			
			.mui-scroll-wrapper,
			.mui-scroll {
				background-color: #FFFFFF;
			}
			
			.mui-page.mui-transitioning {
				-webkit-transition: -webkit-transform 300ms ease;
				transition: transform 300ms ease;
			}
			
			.mui-page-left {
				-webkit-transform: translate3d(0, 0, 0);
				transform: translate3d(0, 0, 0);
			}
			
			.mui-ios .mui-page-left {
				-webkit-transform: translate3d(-20%, 0, 0);
				transform: translate3d(-20%, 0, 0);
			}
			
			.mui-navbar {
				position: fixed;
				right: 0;
				left: 0;
				z-index: 10;
				height: 44px;
				background-color: #f7f7f8;
			}
			
			.mui-navbar .mui-bar {
				position: absolute;
				background: transparent;
				text-align: center;
			}
			
			.mui-android .mui-navbar-inner.mui-navbar-left {
				opacity: 0;
			}
			
			.mui-ios .mui-navbar-left .mui-left,
			.mui-ios .mui-navbar-left .mui-center,
			.mui-ios .mui-navbar-left .mui-right {
				opacity: 0;
			}
			
			.mui-navbar .mui-btn-nav {
				-webkit-transition: none;
				transition: none;
				-webkit-transition-duration: .0s;
				transition-duration: .0s;
			}
			
			.mui-navbar .mui-bar .mui-title {
				display: inline-block;
				width: auto;
			}
			
			.mui-page-shadow {
				position: absolute;
				right: 100%;
				top: 0;
				width: 16px;
				height: 100%;
				z-index: -1;
				content: '';
			}
			
			.mui-page-shadow {
				background: -webkit-linear-gradient(left, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
				background: linear-gradient(to right, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
			}
			
			.mui-navbar-inner.mui-transitioning,
			.mui-navbar-inner .mui-transitioning {
				-webkit-transition: opacity 300ms ease, -webkit-transform 300ms ease;
				transition: opacity 300ms ease, transform 300ms ease;
			}
			
			.mui-page {
				display: none;
			}
			
			.mui-pages .mui-page {
				display: block;
			}
			
			.mui-page .mui-table-view:first-child {
				margin-top: 15px;
			}
			
			.mui-page .mui-table-view:last-child {
				margin-bottom: 30px;
			}
			
			.mui-table-view {
				margin-top: 20px;
			}
			
			.mui-table-view span.mui-pull-right {
				color: #999;
			}
			
			.mui-table-view-divider {
				background-color: #FFFFFF;
				font-size: 14px;
			}
			
			.mui-table-view-divider:before,
			.mui-table-view-divider:after {
				height: 0;
			}
			
			.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			
			.mui-ios .mui-navbar .mui-bar .mui-title {
				position: static;
			}
			
			.left_jiage {
				float: left;
				padding: 10px 0;
				margin-top: 6px;
			}
			
			html {
				background: #FFFFFF;
			}
			
			.zhifu {
				width: 30%;
				float: right;
				background: #CF2D28;
				color: #FFFFFF;
				border: none;
				margin-top: 25px;
			}
			
			.footer {
				padding: 0 10px;
				border-top: 1px solid #EEE;
			}
			
			.mui-slider-right {
				position: relative;
			}
			
			.mui-slider-right .mui-btn {
				position: relative;
				top: 0px;
			}
			
			.huise {
				position: relative !important;
			}
			
			.mui-table-view-cell:after {
				display: none;
			}
			
			p {
				margin-bottom: 0;
				line-height: 1.5em;
			}
			
			.jiesuan li {
				border-bottom: 1px solid #EEEEEE;
				padding: 10px 0;
				`
			}
			
			.mui-table-view-cell {
				font-size: 16px;
			}
			
			.neirong {
				min-height: 200px;
			}
			
			.footer {
				border: none !important;
				padding: 5px;
				border-top: 1px solid #CCCCCC !important;
				height: 80px !important;
			}
			
			.mui-table-view {
				margin-top: 0;
			}
			
			.mui-input-row label {
				width: auto;
				padding: 10px 10px 15px 5px;
			}
			
			.mui-input-row label~input {
				width: 70%;
				padding: 10px 0;
			}
			
			#bottomPopover {
				left: 0 !important;
			}
			
			.dizhi {
				padding: 5px !important;
			}
			
			.dizhi a {
				font-size: 16px !important;
			}
		</style>
	</head>

	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="setting" class="mui-page">
			<!--页面标题栏开始-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">结算中心</h1>
			</div>
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul id="myorders" class="mui-table-view mui-table-view-chevron neirong">

						</ul>
						<!--<div class="repair3_table mui-content jiesuan">
							<ul id="myorders">
							</ul>
						</div>-->
						<!-- FOOTER区域-->
						<nav class=" footer">
							<div id="dizhisub" class="dizhisub" style="line-height: 30px; color:#666666;"></div>

							<a href="#change_address" class="font-blue" style="font-size: 16px; float: right;">选择地址</a>
							<!--id="address"-->
							<p class="black" style="margin-top: 25px;">支付方式</p>
							<ul class="mui-table-view mui-table-view-radio">
								<li class="mui-table-view-cell"><a class="mui-navigate-right">华晟一卡通</a></li>
								<div style="display:none;" id="enter">
									<div class="mui-input-row">
										<label>账号</label>
										<input id='yktaccount' type="text" class="mui-input-clear mui-input" placeholder="请输入账号">
									</div>
									<div class="mui-input-row">
										<label>密码</label>
										<input id='yktpassword' type="password" class="mui-input-clear mui-input" placeholder="请输入密码">
									</div>
								</div>
								<li class="mui-table-view-cell mui-selected"><a class="mui-navigate-right">支付宝</a></li>
							</ul>

							<div class="clear"></div>
							<div class="left_jiage">

								<strong>共计：<span id="mx_jiage" class="font-red mx_jiage">￥</span></strong>
								<p id="jifeng">本次消费可获得积分：</p>
							</div>
							<button id="zhifu" class="zhifu">
								去结算
							</button>
						</nav>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>
		<div id="change_address" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>结算中心
				</button>

				<h1 class="mui-center mui-title">更换地址</h1>
			</div>

			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<ul id="DeliveryAddress" class="mui-table-view">

					</ul>
					<!--<ul class="mui-table-view mui-table-view-chevron">
						<li class="mui-table-view-cell">
							<a href="#bottomPopover" class="mui-navigate-right">添加新地址</a>
						</li>
					</ul>-->
					<a href="#bottomPopover" class="mui-btn-primary mui-btn" style="width: 30%; margin: 10px 30%;">添加新地址</a>
				</div>
			</div>
		</div>

		<!--主界面区域-->

		<a href="#bottomPopover" class="mui-btn-primary mui-btn" style="width: 30%; margin: 10px 30%;">添加新地址</a>

		<div id="bottomPopover" class="mui-popover mui-popover-bottom">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll" style="padding: 5px;">
					<div class="mui-input-row">
						<label>姓名：</label>
						<input id="uname" placeholder="收货人姓名">
						<input id="ID" type="hidden">
					</div>
					<div class="mui-input-row">
						<label>电话：</label>
						<input id="tel" placeholder="收货人手机号，方便联系收货">
					</div>
					<textarea id="adderss" class="mui-input-clear question" placeholder="填写常用地址"></textarea>
					<a id="addressbtn" href="#bottomPopover" class="mui-btn-primary mui-btn mui-pull-right" style="width:15%; margin: 5px 20px">确定</a>
				</div>
			</div>
		</div>
		<!--主界面区域-->

		<script src="../js/mui.view.js "></script>
		<script>
			mui('.mui-scroll-wrapper').scroll();
			var viewApi = mui('#app').view({
				defaultPage: '#setting'
			});
			//********************************************************需要结算的订单数据代码*****************************************
			var orderids = "";
			window.addEventListener('newsId', function(event) {
					//获得事件参数
					var cuxiao_id = event.detail.id;
					mui.ajax('http://101.201.196.202:82/MyOrders/index', {
						data: {
							"ids": cuxiao_id.toString(),
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'Post', //HTTP请求类型,
						timeout: 10000, //超时时间设置为10秒；
						success: function(data) {
							var myorders = "";
							var totalprice = 0;
							for (var i = 0; i < data.length; i++) {
								myorders += "<li id=\"" + data[i].ID + "\"><p>" + data[i].OrdersName + "<span class=\"font-red mui-pull-right\">￥" + data[i].TotalPrice + "</span></p></li>";
								totalprice += data[i].TotalPrice;
								orderids += data[i].ID;
							}
							$("#myorders").html(myorders);
							$("#mx_jiage").html("￥" + totalprice);
							$("#jifeng").html("本次消费可获得积分：" + totalprice);
						}
					})
				})
				//*****************************获取默认收货地址**********************************
			mui.ajax('http://101.201.196.202:82/DeliveryAddress/Default', {
					data: {},
					dataType: 'json', //服务器返回json格式数据
					type: 'Post', //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						if (data.ConsigneeName != null) {
							$(".dizhisub").html("<p id=\"" + data.ID + "\" class=\"black\">收货人：" + data.ConsigneeName + " <span class=\"mui-pull-right\" ：>联系电话：" + data.ConsigneePhone + "</span></p><p id=\"default_address\">地址：" + data.Address + "</p>");
						}
					}
				})
				//*****************************以下为调用支付宝开始支付操作****************************
			var channels = null;
			// 监听plusready事件  
			document.addEventListener("plusready", function() {
				// 扩展API加载完毕，现在可以正常调用扩展API
				plus.payment.getChannels(function(s) {
					
					for (var i in s) {
						var channel = s[i];
						if (channel.id === 'alipay') {
							channels = channel;
							
						}
					}
				}, function(e) {
					alert("获取支付通道列表失败：" + e.message);
				});
			}, false);
			//一卡通账号密码
			var yktaccount = document.getElementById('yktaccount');
			var yktpassword = document.getElementById('yktpassword');
			var dizhisub = document.getElementById('dizhisub');
			var paymethod = document.querySelector('.mui-table-view-cell.mui-selected').innerText;
			var list = document.querySelector('.mui-table-view.mui-table-view-radio');
			//*************************************监听radio的选择事件******************************
			list.addEventListener('selected', function(e) {
				paymethod = e.detail.el.innerText;
				//				console.log(paymethod);
				if (paymethod.length > 4) {
					$("#enter").show();
				} else {
					$("#enter").hide();
				}
			});
			document.getElementById("zhifu").addEventListener("tap", function() {
					var deliveryaddress_id = $("#dizhisub p").attr("id");
					//***********************************支付交易之前，将收货地址添加到数据库**********************************
					mui.ajax('http://101.201.196.202:82/MyOrders/Myorder_DeliveryAddress', {
							data: {
								order_id: orderids,
								deliveryaddress_id: deliveryaddress_id
							},
							dataType: 'json', //服务器返回json格式数据
							type: 'Post', //HTTP请求类型,
							timeout: 10000, //超时时间设置为10秒；
							success: function(data) {
								if (data.statusCode == "300") {
									plus.ui.toast("系统内部错误，请联系管理员……");
									return;
								}
							}
						})
						// 必须从业务服务器获取支付信息
					var statement = "";
					//******************************************选择支付宝支付************************************
					if (paymethod.length == 4) {
						plus.nativeUI.showWaiting( "支付宝启动中……" );
						if (dizhisub.innerHTML.length == 0) {
							plus.ui.toast("请先添加收货地址……");
							return;
						}
						mui.ajax('http://101.201.196.202:82/Alipay/GetPayInfo', {
							data: {
								orderid: orderids
							},
							dataType: 'json', //服务器返回json格式数据
							type: 'Post', //HTTP请求类型,
							timeout: 10000, //超时时间设置为10秒；
							success: function(data) {
								//								console.log(JSON.stringify(data))
								if (channels!=null) {
									plus.nativeUI.closeWaiting("支付宝启动中……");
								} 
								statement = data;
								plus.payment.request(channels, statement, function() {
									plus.ui.toast("支付操作成功！");
									//关闭当前页面
									var ws = plus.webview.currentWebview();
									plus.webview.close(ws);
								}, function(e) {
									if (e.message.indexOf("62000") >= 0) {
										plus.ui.toast("请先安装支付宝插件！");
									}
									if (e.message.indexOf("62001") >= 0) {
										plus.ui.toast("您已取消操作");
									}
									if (e.message.indexOf("62002") >= 0) {
										plus.ui.toast("此设备不支持支付");
									}
									if (e.message.indexOf("62003") >= 0) {
										plus.ui.toast("数据格式错误");
									}
									if (e.message.indexOf("62004") >= 0) {
										plus.ui.toast("支付账号状态错误");
									}
									if (e.message.indexOf("62005") >= 0) {
										plus.ui.toast("订单信息错误");
									}
									if (e.message.indexOf("62006") >= 0) {
										plus.ui.toast("支付操作内部错误");
									}
									if (e.message.indexOf("62007") >= 0) {
										plus.ui.toast("支付服务器错误");
									}
									if (e.message.indexOf("62008") >= 0) {
										plus.ui.toast("网络问题引起的错误");
									}
									if (e.message.indexOf("62009") >= 0) {
										plus.ui.toast("其它未定义的错误");
									}
								});
							}
						})
					} else {
						if (yktaccount.value == "") {
							plus.ui.toast("请添写账号");
							return;
						}
						if (yktpassword.value == "") {
							plus.ui.toast("请添写密码");
							return;
						}
						//*****************************************选择华城一卡通支付******************************************
						mui.ajax('http://101.201.196.202:82/MerchandisePay/MerPay', {
								data: {
									orderid: orderids,
									yktaccount: yktaccount.value,
									yktpassword: yktpassword.value
								},
								dataType: 'json', //服务器返回json格式数据
								type: 'Post', //HTTP请求类型,
								timeout: 10000, //超时时间设置为10秒；
								success: function(data) {
									if (data.statusCode == "200") {
										plus.ui.toast(data.message);
										//关闭当前页面
										var ws = plus.webview.currentWebview();
										plus.webview.close(ws);
									} else {
										plus.ui.toast(data.message);
									}
								}
							})
							//													console.log(yktaccount.value+"+++++"+yktpassword.value)
					}
				})
				//********************************************************需要结算的数据代码结束*****************************************
				////********************************************************更换地址的数据代码开始*****************************************
			getaddress();

			function getaddress() {
				mui.ajax('http://101.201.196.202:82/DeliveryAddress/index', {
					data: {},
					dataType: 'json', //服务器返回json格式数据
					type: 'Post', //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						var str = "";
						for (var i = 0; i < data.length; i++) {
							str += "<div  class=\"dizhi\" style=\"line-height: 30px; color:#666666;\"><div id=\"" + data[i].ID + "\" class=\"dizhilist\"><p class=\"black\">收货人：" + data[i].ConsigneeName + " <span class=\"mui-pull-right\" ：>联系电话：" + data[i].ConsigneePhone + "</span></p><p>收货地址：" + data[i].Address + "</p></div><a class=\"mui-pull-right font-red\" style=\"margin-left: 10px;\">删除 </a><a href=\"#bottomPopover\" class=\"mui-pull-right font-blue\"> 修改信息</a><div style=\"clear: both;\"></div></div>";
						}
						$("#DeliveryAddress").html(str);
					}
				})
			}
			//**********************************************添加、修改收货地址提交代码**************************************
			var addressbtn = document.getElementById('addressbtn');
			var uname = document.getElementById('uname');
			var tel = document.getElementById('tel');
			var adderss = document.getElementById('adderss');
			var ID = document.getElementById('ID');
			addressbtn.addEventListener('tap', function(event) {
				if (uname.value == "") {
					plus.ui.toast("收货人姓名不能为空");
					return;
				}
				if (tel.value == "") {
					plus.ui.toast("收货人电话不能为空");
					return;
				}
				if (adderss.value == "") {
					plus.ui.toast("收货地址不能为空");
					return;
				}
				//****************************用户提交成功返回*********************************
				mui.ajax('http://101.201.196.202:82/DeliveryAddress/Creates', {
					data: {
						"ConsigneeName": uname.value,
						"ConsigneePhone": tel.value,
						"Address": adderss.value,
						"ID": ID.value,
						"isDefault": "0"
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'Post', //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						if (data.statusCode == 200) {
							plus.ui.toast(data.message);
							uname.value = "";
							tel.value = "";
							adderss.value = "";
							getaddress();
						} else {
							plus.ui.toast(data.message);
						}
					}
				})
			});
			////********************************************************删除地址信息*****************************************
			mui('#DeliveryAddress').on('tap', '.font-red', function(e) {
				var DeliveryAddressid = this.parentElement.childNodes[0].getAttribute('id');
				mui.ajax('http://101.201.196.202:82/DeliveryAddress/Delete', {
					data: {
						id: DeliveryAddressid,
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'Post', //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						if (data.statusCode = "200") {
							plus.ui.toast(data.message);
							getaddress();
						} else {
							plus.ui.toast(data.message);
						}
					}
				})
			});
			////********************************************************修改地址信息*****************************************
			mui('#DeliveryAddress').on('tap', '.font-blue', function(e) {
				var DeliveryAddressid = this.parentElement.childNodes[0].getAttribute('id');
				mui.ajax('http://101.201.196.202:82/DeliveryAddress/getdeliveryaddressbyid', {
					data: {
						id: DeliveryAddressid,
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'Post', //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						ID.value = data.ID;
						uname.value = data.ConsigneeName;
						tel.value = data.ConsigneePhone;
						adderss.value = data.Address;
					}
				})
			});
			////********************************************************更换地址的数据代码开始*****************************************
			//**********************************以下为页面切换代码******************************
			var view = viewApi.view;
			(function($, doc) {
				//处理view的后退与webview后退
				var oldBack = $.back;
				$.back = function() {
					if (viewApi.canBack()) { //如果view可以后退，则执行view的后退
						viewApi.back();
					} else { //执行webview后退
						oldBack();
					}
				};
				//监听页面切换事件方案1,通过view元素监听所有页面切换事件，目前提供pageBeforeShow|pageShow|pageBeforeBack|pageBack四种事件(before事件为动画开始前触发)
				//第一个参数为事件名称，第二个参数为事件回调，其中e.detail.page为当前页面的html对象
				view.addEventListener('pageBeforeShow', function(e) {});
				view.addEventListener('pageShow', function(e) {});
				view.addEventListener('pageBeforeBack', function(e) {});
				view.addEventListener('pageBack', function(e) {});
				//*************************************地址点击带回********************************
				var dizhisub = doc.getElementById("dizhisub");
				mui('#DeliveryAddress').on('tap', '.dizhilist', function(e) {
					var DeliveryAddressid = this.getAttribute('id');
					mui.ajax('http://101.201.196.202:82/DeliveryAddress/getdeliveryaddressbyid', {
						data: {
							id: DeliveryAddressid,
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'Post', //HTTP请求类型,
						timeout: 10000, //超时时间设置为10秒；
						success: function(data) {
							if (data.ID != null) {
								var dizhidata = "<p id=\"" + data.ID + "\" class=\"black\">收货人：" + data.ConsigneeName + " <span class=\"mui-pull-right\" ：>联系电话：" + data.ConsigneePhone + "</span></p><p id=\"default_address\">地址：" + data.Address + "</p>"
								dizhisub.innerHTML = dizhidata;
								viewApi.back();
							} else {
								plus.ui.toast(data);
							}
						}
					})
				});
				//*************************************地址点击带回结束********************************
			})(mui, document);
			//**********************************页面切换代码结束******************************
		</script>

	</body>

</html>