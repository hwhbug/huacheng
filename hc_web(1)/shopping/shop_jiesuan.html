<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/style.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/cross-down.css" rel="stylesheet" />
		<script src="../js/jquery-1.9.1.min.js" type="text/javascript"></script>
		<style>
			.left_jiage {
				float: left;
				padding: 10px 0;
				margin-top: 6px;
			}
			
			html {
				background: #FFFFFF;
			}
			
			.zhifu {
				width: 30%;
				float: right;
				background: #CF2D28;
				color: #FFFFFF;
				border: none;
				margin-top: 25px;
			}
			
			.footer {
				padding: 0 10px;
				border-top: 1px solid #EEE;
			}
			
			.mui-slider-right {
				position: relative;
			}
			
			.mui-slider-right .mui-btn {
				position: relative;
				top: 0px;
			}
			
			.huise {
				position: relative !important;
			}
			
			.mui-table-view-cell:after {
				display: none;
			}
			
			p {
				margin-bottom: 0;
				line-height: 1.5em;
			}
			
			.jiesuan li {
				border-bottom: 1px solid #EEEEEE;
				padding: 10px 0;
				`
			}
			
			.mui-table-view-cell {
				font-size: 16px;
			}
		</style>
	</head>

	<body>

		<!-- 侧滑导航根容器 -->

		<header class="mui-bar mui-bar-nav">
			<a id="back_index" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">结算中心</h1>
		</header>

		<!--主界面区域-->
		<div class="repair3_table mui-content jiesuan">
			<ul id="myorders">
				<!--<li>
					<p>蓝月亮洗衣液x1<span class="font-red mui-pull-right">￥50.00</span></p>
				</li>-->
			</ul>

		</div>
		<!-- FOOTER区域-->
		<nav class="mui-bar mui-bar-tab footer">
			<div id="dizhi" class="dizhi" style="line-height: 30px; color:#666666;"></div>
			<p class="center font-blue" id="address">更换地址</p>
			<p class="black">支付方式</p>
			<ul class="mui-table-view mui-table-view-radio">
				<li class="mui-table-view-cell">
					<a class="mui-navigate-right">
						华晟一卡通
					</a>
				</li>
				<li class="mui-table-view-cell mui-selected">
					<a class="mui-navigate-right">
						支付宝
					</a>
				</li>
			</ul>

			<div class="clear"></div>
			<div class="left_jiage">

				<strong>共计：<span id="mx_jiage" class="font-red mx_jiage">￥</span></strong>
				<p id="jifeng">本次消费可获得积分：</p>
			</div>
			<button id="zhifu" class="zhifu">
				去结算
			</button>
		</nav>

		<script src="../js/mui.min.js"></script>
		<script>
			mui('.mui-scroll-wrapper').scroll();
			var orderids="";
			window.addEventListener('newsId', function(event) {
					//获得事件参数
					var cuxiao_id = event.detail.id;
					mui.ajax('http://101.201.196.202:82/MyOrders/index', {
						data: {
							"ids": cuxiao_id.toString(),
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'Post', //HTTP请求类型,
						timeout: 10000, //超时时间设置为10秒；
						success: function(data) {
							var myorders = "";
							var totalprice = 0;
							for (var i = 0; i < data.length; i++) {
								myorders += "<li id=\"" + data[i].ID + "\"><p>" + data[i].OrdersName + "<span class=\"font-red mui-pull-right\">￥" + data[i].TotalPrice + "</span></p></li>";
								totalprice += data[i].TotalPrice;
								orderids+=data[i].ID+",";
							}
							
							$("#myorders").html(myorders);
							$("#mx_jiage").html("￥" + totalprice);
							$("#jifeng").html("本次消费可获得积分：" + totalprice);
						}
					})
				})
				//*****************************获取默认收货地址**********************************
			mui.ajax('http://101.201.196.202:82/DeliveryAddress/Default', {
					data: {},
					dataType: 'json', //服务器返回json格式数据
					type: 'Post', //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						if (data.ConsigneeName != null) {
							$(".dizhi").html("<p id=\"" + data.ID + "\" class=\"black\">收货人：" + data.ConsigneeName + " <span class=\"mui-pull-right\" ：>联系电话：" + data.ConsigneePhone + "</span></p><p id=\"default_address\">地址：" + data.Address + "</p>");
						}
					}
				})
				//**************************收货地址管理*****************************
			document.getElementById('address').addEventListener('tap', function() {
				//打开关于页面
				mui.openWindow({
					url: 'shop_dizhi.html',
					id: 'shop_dizhi'
				});
			});
			//*****************************以下为调用支付宝开始支付操作****************************
			var channels = null;
			// 监听plusready事件  
			document.addEventListener("plusready", function() {
				// 扩展API加载完毕，现在可以正常调用扩展API
				plus.payment.getChannels(function(s) {
					for (var i in s) {
						var channel = s[i];
						if (channel.id === 'alipay') {
							channels = channel;
						}
					}
				}, function(e) {
					alert("获取支付通道列表失败：" + e.message);
				});
			}, false);
			var dizhi = document.getElementById('dizhi');
			document.getElementById("zhifu").addEventListener("tap", function() {
				if (dizhi.innerHTML.length == 0) {
					plus.ui.toast("请先添加收货地址……");
					return;
				}
				
				// 必须从业务服务器获取支付信息
				var statement = "";
				mui.ajax('http://101.201.196.202:82/Alipay/GetPayInfo', {
					data: {
						orderid: orderids
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'Post', //HTTP请求类型,
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						statement = data;
						plus.payment.request(channels, statement, function() {
							alert("支付操作成功！");
						}, function(e) {
							if(e.message.indexOf("62000")>=0){
								plus.ui.toast("请先安装支付宝插件！");
							}
							if(e.message.indexOf("62001")>=0){
								plus.ui.toast("您已取消操作");
							}
							if(e.message.indexOf("62002")>=0){
								plus.ui.toast("此设备不支持支付");
							}
							if(e.message.indexOf("62003")>=0){
								plus.ui.toast("数据格式错误");
							}
							if(e.message.indexOf("62004")>=0){
								plus.ui.toast("支付账号状态错误");
							}
							if(e.message.indexOf("62005")>=0){
								plus.ui.toast("订单信息错误");
							}
							if(e.message.indexOf("62006")>=0){
								plus.ui.toast("支付操作内部错误");
							}
							if(e.message.indexOf("62007")>=0){
								plus.ui.toast("支付服务器错误");
							}
							if(e.message.indexOf("62008")>=0){
								plus.ui.toast("网络问题引起的错误");
							}
							if(e.message.indexOf("62009")>=0){
								plus.ui.toast("其它未定义的错误");
							}
						});
					}
				})
			})
		</script>

	</body>

</html>